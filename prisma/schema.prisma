generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
}

model User {
  id           String @id @default(cuid())
  name         String
  email        String @unique
  passwordHash String
  role         Role   @default(USER)

  isEmailVerified Boolean @default(false)
  isArchived      Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions Session[]
  tokens   Token[]

  subscriptions UserSubscription[]
  folders       Folder[]
  files         File[]
}

model Session {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt  DateTime  @default(now())
  lastSeenAt DateTime?
  revokedAt  DateTime?

  userAgent String?
  ip        String?

  @@index([userId])
  @@index([revokedAt])
}

enum TokenType {
  EMAIL_VERIFY
  PASSWORD_RESET
}

model Token {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      TokenType
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([type])
  @@index([expiresAt])
}

enum FileKind {
  IMAGE
  VIDEO
  PDF
  AUDIO
}

model Package {
  id   String @id @default(cuid())
  name String @unique

  maxFolders      Int
  maxNestingLevel Int
  allowedTypes    FileKind[]
  maxFileSizeMB   Int
  totalFileLimit  Int
  filesPerFolder  Int

  isSystem Boolean @default(false)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions UserSubscription[]
}

model UserSubscription {
  id        String @id @default(cuid())
  userId    String
  packageId String

  user User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  pkg  Package @relation(fields: [packageId], references: [id])

  startAt DateTime  @default(now())
  endAt   DateTime?

  @@index([userId])
  @@index([packageId])
  @@index([endAt])
}

model Folder {
  id     String @id @default(cuid())
  userId String
  name   String

  parentId String?
  parent   Folder?  @relation("FolderToFolder", fields: [parentId], references: [id], onDelete: Cascade)
  children Folder[] @relation("FolderToFolder")

  depth Int

  isArchived Boolean   @default(false)
  archivedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  files File[]

  @@unique([userId, parentId, name])
  @@index([userId])
  @@index([parentId])
  @@index([isArchived])
}

model File {
  id       String @id @default(cuid())
  userId   String
  folderId String

  name      String
  kind      FileKind
  sizeBytes Int

  storagePath String
  publicUrl   String?
  mimeType    String?

  isArchived Boolean   @default(false)
  archivedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  folder Folder @relation(fields: [folderId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([folderId])
  @@index([isArchived])
}
